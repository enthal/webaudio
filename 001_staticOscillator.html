<html>

<head>
  <title>Web Audio demo 1 - Static oscillator</title>
  <style>

    body { font-size: 300%; text-align: center; }
    #playStopButton:before { content: "▶︎"; }
    .playing #playStopButton:before { content: "||"; }
    #restartButton:before { content: "⎌"; }
  </style>
</head>

<body id=appRoot>
  <div id=playStopButton></div>
  <div id=restartButton ></div>
  <div id=beatValue ></div>
  <div id=timeValue ></div>
</div>
</body>

<script>
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  const freqForMidiNoteNumber = n => Math.pow(2, (n-69)/12) * 440

  const master = audioCtx.createGain();
  master.gain.value = 0.2;
  master.connect(audioCtx.destination);

  const playingNodeSet = new Set;

  const playOscillator = (midiNote, startTime) => {
    if (!midiNote) return;
    const duration = 0.5;
    const oscillator = audioCtx.createOscillator();
    // oscillator.type = 'triangle';
    oscillator.frequency.value = freqForMidiNoteNumber(midiNote);
    oscillator.start(startTime + 0.0);
    oscillator.stop (startTime + duration*2);

    const envelope = audioCtx.createGain();
    envelope.gain.setValueAtTime               (0.0, startTime + 0);                 // initial
    envelope.gain.linearRampToValueAtTime    (0.001, startTime + duration * 0.00000001);  // exponentialRampToValueAtTime clicks if started from 0
    envelope.gain.exponentialRampToValueAtTime (1.0, startTime + duration * 0.015);  // Attack
    envelope.gain.exponentialRampToValueAtTime (0.3, startTime + duration * 0.4);    // Decay
    envelope.gain.setValueAtTime               (0.3, startTime + duration * 0.8);    // Sustain
    envelope.gain.linearRampToValueAtTime      (0.0, startTime + duration * 2.0);    // Release

    oscillator.connect(envelope);
    envelope.connect(master);

    playingNodeSet.add(oscillator);
    oscillator.onended = () => {  // on stop/end by _any_ means
      playingNodeSet.delete(oscillator);
      // console.log("end", audioCtx.currentTime);
    }
    // console.log("start", startTime, midiNote, audioCtx.currentTime, );
  }

  let playing = false
  const bps = 160/60;
  const lookaheadDuration = 1
  let startTime = audioCtx.currentTime
  const beatValueDomNode = document.querySelector('#beatValue');
  const timeValueDomNode = document.querySelector('#timeValue');

  let beatI = 0;  // lookahead beat
  const scheduleOscillator = () => {
    const playTime = audioCtx.currentTime - startTime;
    for (let beatTime; (beatTime = 1/bps * beatI) < playTime + lookaheadDuration; beatI++) {
      playOscillator(
        69 + (    // MIDI A4
          !(beatI%16) ? -12 :
          !(beatI%4)  ?  -7 : 0 ),
        startTime + beatTime )

      // timeValueDomNode.innerText = playTime;
      beatValueDomNode.innerText = Math.floor(playTime * bps);
      timeValueDomNode.innerText = (+beatValueDomNode.innerText / bps).toFixed(2);

      console.log("beat", beatI, beatTime, playTime, audioCtx.currentTime)
    }
  }

  const scheduleAll = () => {
    scheduleOscillator();
    window.requestAnimationFrame(scheduleAll)
  }
  window.requestAnimationFrame(scheduleAll)  // https://www.html5rocks.com/en/tutorials/audio/scheduling/

  audioCtx.suspend();
  document.querySelector('#playStopButton').addEventListener('click', () => {
    playing = !playing
    document.querySelector('#appRoot').classList.toggle('playing',playing)
    playing ? audioCtx.resume() : audioCtx.suspend();
    console.log("playing",playing);
  })
  document.querySelector('#restartButton').addEventListener('click', () => {
    console.log("restart");
    playingNodeSet.forEach( x => { console.log(x); x.stop(); } );
    startTime = audioCtx.currentTime;
    beatI = 0;
  })

</script>

</html>
