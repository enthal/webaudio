<html>

<head>
  <title>Web Audio demo 1</title>
</head>

<body>
</body>

<script>
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  const midiNotes = {
    C4: 60,
    A4: 69,
  }
  const freqForMidiNoteNumber = n => Math.pow(2, (n-69)/12) * 440

  const gainNode = audioCtx.createGain();
  gainNode.gain.setValueAtTime(0.20, audioCtx.currentTime);
  gainNode.connect(audioCtx.destination);

  const playOscillator = (midiNote, startTime) => {
    if (!midiNote) return;
    const oscillator = audioCtx.createOscillator();
    // oscillator.type = 'triangle';
    oscillator.frequency.setValueAtTime(freqForMidiNoteNumber(midiNote), audioCtx.currentTime); // value in hertz
    oscillator.connect(gainNode);
    oscillator.start(startTime + 0.0);
    oscillator.stop (startTime + 0.1);
    oscillator.onended = () => { console.log("end", audioCtx.currentTime); }
    // console.log("start", startTime, audioCtx.currentTime, midiNote, );
  }

  const bpm = 120
  const lookaheadDuration = 0.5
  const startTime = audioCtx.currentTime

  const notes = [
    midiNotes.A4-12,
    midiNotes.A4,
    midiNotes.A4+7,
    midiNotes.A4,
  ]
  let beatI = 0;
  const schedule = () => {
    for (let beatTime; (beatTime = 60 * 1/bpm * beatI) < audioCtx.currentTime + lookaheadDuration; beatI++) {
      playOscillator(notes[beatI % notes.length], beatTime)
      console.log("beat", beatI % notes.length, beatI, beatTime, audioCtx.currentTime)
    }
    window.requestAnimationFrame(schedule)
  }
  window.requestAnimationFrame(schedule)

</script>

</html>
