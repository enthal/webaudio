<html>

<head>
  <title>Web Audio demo 2 - Step sequencer</title>
  <style>

    body {
      text-align: center;
      font-family: sans-serif;
    }

    #top-controls {
      padding: 0.2em;
      background-color: #f7f7f7;
    }
    #top-controls *:not(.row) {
      background-color: #DDD;
      padding: 0 0.2em;
      border-radius: 10px;
    }
    #top-controls .button {
      font-size: 300%;
    }
    #top-controls .value {
      font-size: 200%;
      font-family: monospace;
    }
    #top-controls .control {
      padding: 0.4em;
    }
    #top-controls .control > * {
      display: block;
      text-align: left;
    }
    #top-controls .control label {
      padding-right: 1em
    }

    #play-stop-button:before { content: "▶︎"; }
    .playing #play-stop-button:before { content: "||"; }
    #restart-button:before { content: "⎌"; }

    #beat-grid button {
      background-color: #444;
      width:  4em;
      height: 4em;
    }
    #beat-grid button.on {
      background-color: #DD0;
    }
    #beat-grid button.current {
      background-color: #888;
    }
    #beat-grid button.current.on {
      background-color: #FF3;
    }

    .row > * {
      display: inline-block;
      margin-bottom: 0.2em;
    }
  </style>
</head>

<body id=app-root>

  <div id=top-controls>

    <div class=row>
      <div id=play-stop-button class=button></div>
      <div id=restart-button   class=button></div>
      <div id=beat-value class=value></div>
      <div id=time-value class=value></div>
    </div>

    <div class=row>

      <div id="gain-control" class=control>
        <div>
          <label for="gain-input">Gain</label>
          <span class=value>123</span>
        </div>
        <input name="gain-input" type="range" min="0" max="1" value=0.2 step="0.05" />
      </div>

      <div id="bpm-control" class=control>
        <div>
          <label for="bpm-input">BPM</label>
          <span class=value>123</span>
        </div>
        <input name="bpm-input" type="range" min="1" max="240" value="120" step="1" />
      </div>

    </div>
  </div>

  <div id=beat-grid></div>
</div>
</body>

<script>

  const RUN = () => {
    makeDomBeatGrid();
  }

  ////////////

  const stepCount = 8;
  const drumNotes = [ 69-12, 69-7, 69 ];  // 69 == MIDI A4
  const grid = [];
  const makeDomBeatGrid = () => {
    drumNotes.forEach( (drumNote, drumI) => {
      const drum = [];
      grid.push(drum);

      const drumRow = document.createElement('div');
      document.querySelector('#beat-grid').appendChild( drumRow );
      for (let stepI = 0; stepI < stepCount; stepI++) {
        drum.push(false);
        const button = document.createElement('button');
        button.addEventListener('click', () => {
          drum[stepI] = !drum[stepI];
          button.classList.toggle('on', drum[stepI]);
          resetLookaheadSchedule();
        });
        drumRow.appendChild(button);
      }
    })
  }

  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const freqForMidiNoteNumber = n => Math.pow(2, (n-69)/12) * 440

  const master = audioCtx.createGain();
  master.gain.value = 0.2;
  master.connect(audioCtx.destination);

  const scheduledNodeSet = new Set;

  const scheduleOscillator = (midiNote, startTime) => {
    const duration = 1.0;
    const oscillator = audioCtx.createOscillator();
    oscillator.$startTime = startTime;  // dirty?  for later cancellation
    // oscillator.type = 'triangle';
    oscillator.frequency.value = freqForMidiNoteNumber(midiNote);
    oscillator.start(startTime + 0.0);
    oscillator.stop (startTime + duration*2);

    const envelope = audioCtx.createGain();
    envelope.gain.setValueAtTime               (0.0, startTime + 0);                 // initial
    envelope.gain.linearRampToValueAtTime    (0.001, startTime + duration * 0.00000001);  // exponentialRampToValueAtTime clicks if started from 0
    envelope.gain.exponentialRampToValueAtTime (1.0, startTime + duration * 0.015);  // Attack
    envelope.gain.exponentialRampToValueAtTime (0.3, startTime + duration * 0.4);    // Decay
    envelope.gain.setValueAtTime               (0.3, startTime + duration * 0.8);    // Sustain
    envelope.gain.linearRampToValueAtTime      (0.0, startTime + duration * 2.0);    // Release

    oscillator.connect(envelope);
    envelope.connect(master);

    scheduledNodeSet.add(oscillator);
    oscillator.onended = () => {  // on stop/end by _any_ means
      scheduledNodeSet.delete(oscillator);
      // console.log("end", audioCtx.currentTime);
    }
    // console.log("schedule start", startTime, midiNote, audioCtx.currentTime, );
  }

  let playing = false
  let bps = 160/60;
  const lookaheadDuration = 1
  const beatValueDomNode = document.querySelector('#beat-value');
  const timeValueDomNode = document.querySelector('#time-value');

  // C.f., https://www.html5rocks.com/en/tutorials/audio/scheduling/
  /*let*/ startTime = audioCtx.currentTime
  /*let*/ beatReal = 0;
  /*let*/ lastBeatI = -1;
  /*let*/ lastScheduledBeatI = -1;
  /*let*/ lastScheduledTime = null;
  /*let*/ lastScheduleCallTime = audioCtx.currentTime;
  const incrementLookaheadSchedule = () => {
    const now = audioCtx.currentTime;
    const playTime = now - startTime;
    const beatI = Math.floor(beatReal);

    if (lastBeatI !== beatI) {
      if (!(beatI%8))  console.log("-- beatI LOOP", beatI%8, beatI);
      lastBeatI = beatI;
      beatValueDomNode.innerText = beatI;
      timeValueDomNode.innerText = playTime.toFixed(2);

      // TODO: instead push beat events to consumers for update
      document.querySelectorAll('#beat-grid button.current')
        .forEach(x=>x.classList.remove('current'));
      document.querySelectorAll(`#beat-grid button:nth-child(${ 1 + beatI % stepCount })`)
        .forEach(x=>x.classList.add('current'));

      console.log("beatI", beatI, playTime.toFixed(2));
    }

    let scheduleBeatI = lastScheduledBeatI;
    for (;;) {
      const beatPart = beatReal - beatI;
      const scheduleTime = (lastScheduledTime == null)
        ? playTime          + (beatPart && 1 - beatPart) / bps
        : lastScheduledTime +                          1 / bps;
      if (scheduleTime > playTime + lookaheadDuration)  break;
      lastScheduledTime = scheduleTime;
      lastScheduledBeatI = ++scheduleBeatI;

      // SCHEDULE A BEAT!
      const stepI = scheduleBeatI % stepCount;
      let scheduledCount = 0;
      drumNotes.forEach( (drumNote, drumI) => {
        if (grid[drumI][stepI]) {
          scheduleOscillator(drumNote, startTime + scheduleTime);
          scheduledCount++;
        }
      });
      if (scheduledCount) {
        console.log("scheduled", scheduledCount, stepI, scheduleBeatI%4,
          scheduleBeatI, beatReal.toFixed(4), (playTime + lookaheadDuration).toFixed(4))
      }
    }

    playing ? audioCtx.resume() : audioCtx.suspend();   // TODO: seems OK to call this every time, but...

    beatReal += (now - lastScheduleCallTime) * bps;
    lastScheduleCallTime = now;
    // console.log("beatReal",beatReal);
  }

  resetLookaheadSchedule = () => {
    // Stop only nodes that haven't started playing.
    console.log("** resetLookaheadSchedule", audioCtx.currentTime)
    scheduledNodeSet.forEach( x => {
      let stopped;
      if (x.$startTime >= audioCtx.currentTime) {   // == if reset to start time while paused
        stopped = true;
        x.stop();  // resulting onended callback will remove from scheduledNodeSet
      }
      console.log(x.$startTime, stopped?"stop":"spare", +(x.$startTime - audioCtx.currentTime).toFixed(4), x);
    } );

    // next incrementLookaheadSchedule will rebuild
    lastScheduledTime = null;
    lastScheduledBeatI = Math.floor(beatReal);
  }

  const scheduleForever = () => {
    incrementLookaheadSchedule();
    window.requestAnimationFrame(scheduleForever)
  }
  window.requestAnimationFrame(scheduleForever)  // https://www.html5rocks.com/en/tutorials/audio/scheduling/

  audioCtx.suspend();
  document.querySelector('#play-stop-button').addEventListener('click', () => {
    playing = !playing
    document.querySelector('#app-root').classList.toggle('playing',playing)
    console.log("playing",playing);
  })
  document.querySelector('#restart-button').addEventListener('click', () => {
    console.log("restart");
    scheduledNodeSet.forEach( x => {
      console.log("stop", x);
      x.stop();  // stop even already-playing notes
    } );
    startTime = audioCtx.currentTime;
    lastScheduledBeatI = -1;
    lastScheduledTime = null;
    lastBeatI = -1;
    beatReal = 0;
    audioCtx.suspend();  // but still perhaps playing==true: if so, will resume in incrementLookaheadSchedule; ensures we schedule first beat!
  })

  const gainControl = document.querySelector('#gain-control');
  const gainInput = gainControl.querySelector('input');
  const gainValue = gainControl.querySelector('.value');
  const adjustGain = () => {
    console.log("gain", +gainInput.value);
    master.gain.linearRampToValueAtTime(+gainInput.value, audioCtx.currentTime + 0.01);
    gainValue.innerText = (+gainInput.value).toFixed(2);
  }
  adjustGain();
  gainInput.addEventListener('input', adjustGain);

  const bpmControl = document.querySelector('#bpm-control');
  const bpmInput = bpmControl.querySelector('input');
  const bpmValue = bpmControl.querySelector('.value');
  const adjustBps = () => {
    console.log("bpm", +bpmInput.value);
    bps = +bpmInput.value / 60;
    bpmValue.innerText = +bpmInput.value;
    resetLookaheadSchedule();
  }
  adjustBps();
  bpmInput.addEventListener('input', adjustBps);

  RUN();

</script>

</html>
